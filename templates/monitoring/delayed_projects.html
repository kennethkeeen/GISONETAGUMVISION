{% extends 'base.html' %}
{% block content %}
<div class="min-h-screen w-full max-w-7xl mx-auto px-4 md:px-8 py-4">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-extrabold text-gray-900">Delayed Projects</h1>
        <p class="mt-2 text-gray-600">Total Delayed Projects: <span id="total-delayed">{{ total_delayed }}</span></p>
    </div>

    <!-- Filters -->
    <form method="get" class="mb-6 flex flex-wrap gap-4">
        <select name="barangay" id="filter-barangay" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500" onchange="this.form.submit()">
            <option value="" {% if not request.GET.barangay %}selected{% endif %}>All Barangays</option>
            <option value="Apokon" {% if request.GET.barangay == 'Apokon' %}selected{% endif %}>Apokon</option>
            <option value="Bincungan" {% if request.GET.barangay == 'Bincungan' %}selected{% endif %}>Bincungan</option>
            <option value="Busaon" {% if request.GET.barangay == 'Busaon' %}selected{% endif %}>Busaon</option>
            <option value="Canocotan" {% if request.GET.barangay == 'Canocotan' %}selected{% endif %}>Canocotan</option>
            <option value="Cuambogan" {% if request.GET.barangay == 'Cuambogan' %}selected{% endif %}>Cuambogan</option>
            <option value="La Filipina" {% if request.GET.barangay == 'La Filipina' %}selected{% endif %}>La Filipina</option>
            <option value="Liboganon" {% if request.GET.barangay == 'Liboganon' %}selected{% endif %}>Liboganon</option>
            <option value="Madaum" {% if request.GET.barangay == 'Madaum' %}selected{% endif %}>Madaum</option>
            <option value="Magdum" {% if request.GET.barangay == 'Magdum' %}selected{% endif %}>Magdum</option>
            <option value="Magugpo East" {% if request.GET.barangay == 'Magugpo East' %}selected{% endif %}>Magugpo East</option>
            <option value="Magugpo North" {% if request.GET.barangay == 'Magugpo North' %}selected{% endif %}>Magugpo North</option>
            <option value="Magugpo Poblacion" {% if request.GET.barangay == 'Magugpo Poblacion' %}selected{% endif %}>Magugpo Poblacion</option>
            <option value="Magugpo South" {% if request.GET.barangay == 'Magugpo South' %}selected{% endif %}>Magugpo South</option>
            <option value="Magugpo West" {% if request.GET.barangay == 'Magugpo West' %}selected{% endif %}>Magugpo West</option>
            <option value="Mankilam" {% if request.GET.barangay == 'Mankilam' %}selected{% endif %}>Mankilam</option>
            <option value="New Balamban" {% if request.GET.barangay == 'New Balamban' %}selected{% endif %}>New Balamban</option>
            <option value="Nueva Fuerza" {% if request.GET.barangay == 'Nueva Fuerza' %}selected{% endif %}>Nueva Fuerza</option>
            <option value="Pagsabangan" {% if request.GET.barangay == 'Pagsabangan' %}selected{% endif %}>Pagsabangan</option>
            <option value="Pandapan" {% if request.GET.barangay == 'Pandapan' %}selected{% endif %}>Pandapan</option>
            <option value="San Agustin" {% if request.GET.barangay == 'San Agustin' %}selected{% endif %}>San Agustin</option>
            <option value="San Isidro" {% if request.GET.barangay == 'San Isidro' %}selected{% endif %}>San Isidro</option>
            <option value="San Miguel" {% if request.GET.barangay == 'San Miguel' %}selected{% endif %}>San Miguel</option>
            <option value="Visayan Village" {% if request.GET.barangay == 'Visayan Village' %}selected{% endif %}>Visayan Village</option>
        </select>
        <input type="text" name="search" id="search-input" value="{{ request.GET.search }}" placeholder="Search projects..." class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
        <select name="sort" id="sort-by" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500" onchange="this.form.submit()">
            <option value="created_at" {% if request.GET.sort == 'created_at' or not request.GET.sort %}selected{% endif %}>Sort by Date</option>
            <option value="name" {% if request.GET.sort == 'name' %}selected{% endif %}>Sort by Name</option>
            <option value="barangay" {% if request.GET.sort == 'barangay' %}selected{% endif %}>Sort by Barangay</option>
        </select>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Apply Filters</button>
        {% if request.GET.barangay or request.GET.search or request.GET.sort %}
        <a href="{% url 'delayed_projects' %}" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">Clear Filters</a>
        {% endif %}
    </form>

    <!-- Projects Table -->
    <div class="bg-white rounded-xl shadow overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PRN</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Barangay</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned Engineers</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="projects-table-body">
                    <!-- Table rows will be rendered by JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script id="delayed-projects-data" type="application/json">
    {{ delayed_projects_json|safe }}
</script>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const projects = JSON.parse(document.getElementById('delayed-projects-data').textContent);
    const tableBody = document.getElementById('projects-table-body');
    const filterBarangay = document.getElementById('filter-barangay');
    const searchInput = document.getElementById('search-input');
    const sortBy = document.getElementById('sort-by');
    const totalDelayed = document.getElementById('total-delayed');

    function renderProjects(filteredProjects) {
        if (filteredProjects.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500">No delayed projects found.</td></tr>`;
            totalDelayed.textContent = 0;
            return;
        }
        tableBody.innerHTML = filteredProjects.map(project => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${project.prn || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${project.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${project.barangay || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-red-600 h-2.5 rounded-full" style="width: ${project.progress}%"></div>
                        </div>
                        <span class="ml-2 text-sm text-gray-600">${project.progress}%</span>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(project.start_date)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(project.end_date)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    ${project.assigned_engineers.map(engineer => `
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 mr-1">
                            ${engineer}
                        </span>
                    `).join('')}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${project.source === 'projeng' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                        ${project.source.charAt(0).toUpperCase() + project.source.slice(1)}
                    </span>
                </td>
            </tr>
        `).join('');
        totalDelayed.textContent = filteredProjects.length;
    }

    function filterAndSortProjects() {
        const barangayFilter = filterBarangay.value;
        const searchTerm = searchInput.value.toLowerCase();
        const sortField = sortBy.value;

        let filteredProjects = projects.filter(project => {
            const matchesBarangay = !barangayFilter || project.barangay === barangayFilter;
            const matchesSearch = !searchTerm || 
                project.name.toLowerCase().includes(searchTerm) ||
                (project.prn || '').toLowerCase().includes(searchTerm) ||
                (project.barangay || '').toLowerCase().includes(searchTerm);
            return matchesBarangay && matchesSearch;
        });

        filteredProjects.sort((a, b) => {
            if (sortField === 'created_at') {
                return new Date(b.created_at) - new Date(a.created_at);
            }
            return (a[sortField] || '').localeCompare(b[sortField] || '');
        });

        renderProjects(filteredProjects);
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    filterBarangay.addEventListener('change', filterAndSortProjects);
    searchInput.addEventListener('input', filterAndSortProjects);
    sortBy.addEventListener('change', filterAndSortProjects);

    // Initial render
    filterAndSortProjects();
});
</script>
{% endblock %}
{% endblock %} 